#include <iostream>
#include <SDL2/SDL.h>
#include <SDL2/SDL_image.h>
#include <vector>
//#include "funcionesDibujar.h"
//#include "cargadorDeescenario->h"
#include "Capa.h"
#include "Escenario.h"
#include "parser.h"
#include "ConversorDeCoordenadas.h"
using namespace std;

void ImprimirError(ostream &os, const string &mensaje){
	os << mensaje <<endl;
}
//----------------------------------------------------------------

int InicializarSDL() {
	if (SDL_Init(SDL_INIT_EVERYTHING) != 0) {
		ImprimirError(cout, "Error al iniciar SDL");
		return 1;
	}
	if ((IMG_Init(IMG_INIT_PNG) & IMG_INIT_PNG) != IMG_INIT_PNG){
	    ImprimirError(cout, "Error con inicializacion de imagenes");
	    SDL_Quit();
	    return 1;
	}
    return 0;
}
//----------------------------------------------------------------
//----------------------------------------------------------------

//---------------------------------------------------
//-----------------------MAIN------------------------
//---------------------------------------------------


class Juego
{
public:
    int argc;   
    char** argv;
	ConversorDeCoordenadas* conv;
    
    bool salir = false;
    SDL_Renderer * renderer = NULL;
    
    Escenario *escenario;

    unsigned int ANCHO_FISICO;
    unsigned int ALTO_FISICO;

    int mover;
    int moverSZ;
    SDL_Window * window = NULL;

    Conf *conf;

    Juego(int argc_, char* argv_[]){
        argc = argc_;
        argv = argv_;
        this->escenario = new Escenario();        
    };
    int jugar(){

        if (InicializarSDL() != 0) return 1;
        renderer = SDL_CreateRenderer(NULL, -1, 0);
        configurar();
//Dibujarse(int x, int y, int alto, int ancho){


        // (escenario->capas[4])->Dibujarse(15+moverSZ ,ALTO_FISICO-170); // ESTA LINEA NO LA PUESO MOVER A LOOP!!!

    game_loop();

       /* fondo->Dibujarse(0 ,0 ,ALTO_FISICO,ANCHO_FISICO);
        columnasMuyLejos->Dibujarse(0.5*mover ,0);
        ColumnasLejos->Dibujarse(mover,0);
        piso->Dibujarse(0,ALTO_FISICO-46);
        Sz->Dibujarse(15+moverSZ ,ALTO_FISICO-170);*/

    // LIBERAR RECURSOS
    terminar_juego();

    terminar_sdl();
    return 0;

    };

    void cargar_configuracion(){
        this->conf = new Conf();
        puts(argv[1]);
        conf->set_values(argv[1]);
        // Se settean configuraciones (con el json)
        // Esto tiene que cambiarse cuando se aprieta la letra R


        //Pantalla
        ANCHO_FISICO = conf->ventana_anchopx; //800
        ALTO_FISICO = conf->ventana_altopx; //416
        //Mundo
        double AnchoLogico, AltoLogico;
        // Martin


        // fin de las configuraciones

    };
    void configurar(){

        cargar_configuracion();

        //SDL_Window* ventana = NULL;

        window = SDL_CreateWindow("Mortal Kombat 3 Ultimate", SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED, ANCHO_FISICO, ALTO_FISICO, SDL_WINDOW_MAXIMIZED);
        renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_SOFTWARE);

        cargar_capas();
    }
    void cargar_capas(){
        for (unsigned int i = 0; i < conf->capas_vector.size(); i++){
            conf->capas_vector[i]->ren = renderer;
            

            // escenario->AgregarCapa(conf->capas_vector[i]); Por algún motivo esto no anda

            escenario->AgregarCapa( // esto no debería estar así, tendria que andar la línea de arriba, pero estuve luchando y no la hago andar (maxi)
                new Capa (conf->capas_vector[i]->ubicacion,
                conf->capas_vector[i]->anchoLogico,
                conf->capas_vector[i]->x_logico,
                conf->capas_vector[i]->ren
                )
            );
        }

    }
    void game_loop(){
        mover = 1;
        moverSZ= 1;
        SDL_Event evento;
        while (!salir){
            SDL_PollEvent( &evento );
            switch(evento.type){
                case SDL_QUIT:
                    salir = true;
                    break;
                case SDL_KEYDOWN:
                    if (evento.key.keysym.sym == SDLK_RIGHT)  {
                        if (abs(mover)<450) mover-= 5;
                        if (abs(-moverSZ)<450) moverSZ +=5;
                        /*cout<<"der "<<mover<<endl;
                        cout<<"ancho del piso: "<< anchoDelPiso<<endl;*/
                    }
                    if ((evento.key.keysym.sym == SDLK_LEFT) && (mover <0) )  {
                        //cout<<"izq "<<mover<<endl;
                        mover+= 5;
                        moverSZ-=5;
                    }
                    if (evento.key.keysym.sym == SDLK_ESCAPE)  salir = true;
                    if (evento.key.keysym.sym == SDLK_r){
                        reiniciarJuego();
                    }
                    break;
           }

            //Limpio y dibujo
            SDL_RenderClear(renderer);


            //fondo
            (escenario->capas[0])->Dibujarse(0,0, ALTO_FISICO,ANCHO_FISICO);
            //CML
            (escenario->capas[1])->Dibujarse(0.5*mover ,0);
            //CL
            (escenario->capas[2])->Dibujarse(mover,0);
            //piso
            (escenario->capas[3])->Dibujarse(0,ALTO_FISICO-46);
            //Sz

            (escenario->capas[4])->Dibujarse(15+moverSZ ,ALTO_FISICO-170); // ESTA LINEA NO LA PUESO MOVER A LOOP!!!
            // SI MUEVO ESTA LINEA ACÁ NO ANDA!!!!!
            
            SDL_RenderPresent(renderer);
        }
    };
    void reiniciarJuego(){
        puts("Tengo que cambiar las configuraciones");
        terminar_juego();
        cargar_configuracion();
        cargar_capas();
        SDL_SetWindowSize(window, ANCHO_FISICO, ALTO_FISICO);

    };
    void terminar_juego(){
        escenario->Borrar();
    };
    void terminar_sdl(){
        SDL_DestroyRenderer(renderer);
        SDL_DestroyWindow(window);
        IMG_Quit();
        SDL_Quit();
    };
    
};



int main(int argc, char* argv[]){
    Juego juego(argc, argv);
    return juego.jugar();
    /*Hola hola;
    return 0;*/

}
